<link rel="import" href="misbehave-empty.html">

<script>

  Polymer.Base._addFeature({

    toBehavior: function() {

      var self = this;

      // An empty component
      var baseComponent = document.createElement('misbehave-empty');

      var basePrototype = Object.getPrototypeOf(baseComponent);
      var thisPrototype = Object.getPrototypeOf(this);

      var baseProtoKeys = Object.keys(basePrototype);

      // Filter out junk we don't want in our behavior definition
      var definitionProtoKeys = Object.keys(thisPrototype).filter(function(prop) {

        // Throw away anything you'd find in every Polymer component
        var inBase = ~baseProtoKeys.indexOf(prop);

        // Throw away readOnly setters, which should be re-generated organically
        var readOnlySetter = false;

        var readOnlyMatch = prop.match(/^_set(.*)$/);

        if (readOnlyMatch) {

          // _setMyProperty -> MyProperty -> myProperty
          var readOnlyProp = readOnlyMatch[1];
          readOnlyProp = readOnlyProp.substr(0, 1).toLowerCase() + readOnlyProp.substr(1);

          if (self.properties &&
              self.properties[readOnlyProp] &&
              self.properties[readOnlyProp].readOnly) {

                readOnlySetter = true;
          }

        }

        return !inBase && !readOnlySetter;
      });

      // Build the behavior definition from the culled prototype keys
      var behaviorDefinition = {};

      var key;
      var descriptor;
      for (var i = 0; i < definitionProtoKeys.length; ++i) {

        key = definitionProtoKeys[i];
        descriptor = Object.getOwnPropertyDescriptor(thisPrototype, key);

        // Set properties this way to preserve getters, setters, etc.
        // One better than `behaviorDefinition[key] = thisPrototype[key]`, but similar
        Object.defineProperty(behaviorDefinition, key, descriptor);
      }

      // Process to mix in any behaviors of the base component
      if (behaviorDefinition.behaviors) {

        // Make a shallow clone of the behaviors
        var subBehaviors = behaviorDefinition.behaviors.concat([]);

        // Remove "behaviors" from the behavior definition
        delete behaviorDefinition.behaviors;

        // Append the raw definition to the list of behaviors
        subBehaviors.push(behaviorDefinition);

        // This is our new behavior definition, a list of sub-behaviors
        behaviorDefinition = subBehaviors;
      }

      behaviorDefinition.injectFrom = function(base, target) {
        var baseElement = document.createElement(base);
        // Grab an instance of the base template!
        // _template is only available if the element hasn't been added to the DOM somewhere!
        var baseTemplateInstance = Polymer.Base.instanceTemplate(Polymer.dom(baseElement).node._template);
        
        // And baseTemplateInstance will only have a children array if it hasn't been added to the DOM yet!
        var self = this;
        Polymer.dom(baseTemplateInstance).children.forEach(function(child) {
          if(child.id) {
            self.$[child.id] = child;
          }
        });
        
        Polymer.dom(this.root).insertBefore(baseTemplateInstance, target);
        Polymer.dom(this.root).removeChild(target);
        
        delete this.$[target.id];
        
      }

      return behaviorDefinition;
    }

  });

</script>
